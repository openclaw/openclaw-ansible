---
# Development mode installation - Clone repo, build from source, link globally

- name: Create code directory
  ansible.builtin.file:
    path: "{{ openclaw_code_dir }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'

- name: Check if openclaw repository already exists
  ansible.builtin.stat:
    path: "{{ openclaw_repo_dir }}/.git"
  register: openclaw_repo_exists

- name: Clone openclaw repository
  ansible.builtin.git:
    repo: "{{ openclaw_repo_url }}"
    dest: "{{ openclaw_repo_dir }}"
    version: "{{ openclaw_repo_branch }}"
    update: true
  become: true
  become_user: "{{ openclaw_user }}"
  when: not openclaw_repo_exists.stat.exists

- name: Pull latest changes if repo exists
  ansible.builtin.git:
    repo: "{{ openclaw_repo_url }}"
    dest: "{{ openclaw_repo_dir }}"
    version: "{{ openclaw_repo_branch }}"
    update: true
  become: true
  become_user: "{{ openclaw_user }}"
  when: openclaw_repo_exists.stat.exists
  register: git_pull_result

- name: Display git pull status
  ansible.builtin.debug:
    msg: "Git repository updated: {{ git_pull_result.changed | default(false) }}"
  when: openclaw_repo_exists.stat.exists

- name: Install dependencies with pnpm
  ansible.builtin.shell:
    cmd: pnpm install
    chdir: "{{ openclaw_repo_dir }}"
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    PNPM_HOME: "{{ openclaw_home }}/.local/share/pnpm"
    PATH: "{{ openclaw_home }}/.local/bin:/home/linuxbrew/.linuxbrew/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ openclaw_home }}"
  register: pnpm_install_result
  changed_when: "'Already up to date' not in pnpm_install_result.stdout"

- name: Build UI (if ui:build script exists)
  ansible.builtin.shell:
    cmd: pnpm ui:build 2>&1 || echo "No ui:build script, skipping"
    chdir: "{{ openclaw_repo_dir }}"
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    PNPM_HOME: "{{ openclaw_home }}/.local/share/pnpm"
    PATH: "{{ openclaw_home }}/.local/bin:/home/linuxbrew/.linuxbrew/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ openclaw_home }}"
  register: ui_build_result
  changed_when: "'No ui:build script' not in ui_build_result.stdout"
  failed_when: false

- name: Build openclaw from source
  ansible.builtin.shell:
    cmd: pnpm build
    chdir: "{{ openclaw_repo_dir }}"
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    PNPM_HOME: "{{ openclaw_home }}/.local/share/pnpm"
    PATH: "{{ openclaw_home }}/.local/bin:/home/linuxbrew/.linuxbrew/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ openclaw_home }}"
  register: pnpm_build_result
  changed_when: true  # Build always changes dist/ directory
  failed_when: false  # Don't fail immediately, we'll check output

- name: Display build output
  ansible.builtin.debug:
    msg: |
      Build exit code: {{ pnpm_build_result.rc }}
      Build stdout: {{ pnpm_build_result.stdout | default('') }}
      Build stderr: {{ pnpm_build_result.stderr | default('') }}

- name: Fail if build had errors
  ansible.builtin.fail:
    msg: "Build failed with exit code {{ pnpm_build_result.rc }}"
  when: pnpm_build_result.rc != 0

- name: List repository contents after build
  ansible.builtin.shell:
    cmd: |
      echo "=== Root directory ==="
      ls -la {{ openclaw_repo_dir }}
      echo ""
      echo "=== Bin directory (if exists) ==="
      ls -la {{ openclaw_repo_dir }}/bin 2>/dev/null || echo "bin/ does not exist"
      echo ""
      echo "=== Dist directory (if exists) ==="
      ls -la {{ openclaw_repo_dir }}/dist 2>/dev/null || echo "dist/ does not exist"
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  register: repo_contents
  changed_when: false

- name: Display repository structure
  ansible.builtin.debug:
    msg: "{{ repo_contents.stdout_lines }}"

- name: Check if dist directory exists
  ansible.builtin.stat:
    path: "{{ openclaw_repo_dir }}/dist"
  register: dist_dir

- name: Fail if build didn't create dist directory
  ansible.builtin.fail:
    msg: "Build failed - dist directory not found"
  when: not dist_dir.stat.exists

- name: Check for openclaw binary location
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ openclaw_repo_dir }}/bin/openclaw.js"
    - "{{ openclaw_repo_dir }}/openclaw.mjs"
    - "{{ openclaw_repo_dir }}/dist/openclaw.mjs"
    - "{{ openclaw_repo_dir }}/dist/index.js"
  register: binary_check

- name: Determine openclaw binary path
  ansible.builtin.set_fact:
    openclaw_binary_path: "{{ item.item }}"
  loop: "{{ binary_check.results }}"
  when: item.stat.exists
  loop_control:
    label: "{{ item.item }}"

- name: Fail if no binary found
  ansible.builtin.fail:
    msg: "Could not find openclaw binary in expected locations"
  when: openclaw_binary_path is not defined

- name: Display found binary path
  ansible.builtin.debug:
    msg: "Found OpenClaw binary at: {{ openclaw_binary_path }}"

- name: Remove existing global openclaw symlink (if any)
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.local/bin/openclaw"
    state: absent

- name: Create symlink to openclaw binary
  ansible.builtin.file:
    src: "{{ openclaw_binary_path }}"
    dest: "{{ openclaw_home }}/.local/bin/openclaw"
    state: link
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    force: true
    follow: false

- name: Make openclaw binary executable
  ansible.builtin.file:
    path: "{{ openclaw_binary_path }}"
    mode: '0755'
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"

- name: Verify openclaw installation from development build
  ansible.builtin.shell:
    cmd: "{{ openclaw_home }}/.local/bin/openclaw --version"
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    PATH: "{{ openclaw_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
  register: openclaw_dev_version
  changed_when: false

- name: Display installed OpenClaw version (development build)
  ansible.builtin.debug:
    msg: |
      âœ… OpenClaw installed from source: {{ openclaw_dev_version.stdout }}
      ðŸ“‚ Repository: {{ openclaw_repo_dir }}
      ðŸ”— Binary: {{ openclaw_home }}/.local/bin/openclaw -> {{ openclaw_binary_path }}

- name: Add development mode info to .bashrc
  ansible.builtin.blockinfile:
    path: "{{ openclaw_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - OpenClaw development"
    block: |
      # OpenClaw development mode
      export OPENCLAW_DEV_DIR="{{ openclaw_repo_dir }}"

      # Aliases for development
      alias openclaw-rebuild='cd {{ openclaw_repo_dir }} && pnpm build'
      alias openclaw-dev='cd {{ openclaw_repo_dir }}'
      alias openclaw-pull='cd {{ openclaw_repo_dir }} && git pull && pnpm install && pnpm build'
    create: true
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0644'
