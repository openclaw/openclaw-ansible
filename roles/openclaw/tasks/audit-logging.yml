---
# Audit logging configuration using auditd
# Provides security event logging for compliance and forensics

- name: Install auditd and plugins
  ansible.builtin.apt:
    name:
      - auditd
      - audispd-plugins
    state: present
    update_cache: true

- name: Configure auditd settings
  ansible.builtin.copy:
    dest: /etc/audit/auditd.conf
    owner: root
    group: root
    mode: '0640'
    content: |
      # OpenClaw Audit Daemon Configuration
      
      # Log file location
      log_file = /var/log/audit/audit.log
      log_format = ENRICHED
      log_group = adm
      
      # Log file rotation
      max_log_file = 50
      max_log_file_action = ROTATE
      num_logs = 5
      
      # Space settings
      space_left = 75
      space_left_action = SYSLOG
      admin_space_left = 50
      admin_space_left_action = SUSPEND
      disk_full_action = SUSPEND
      disk_error_action = SUSPEND
      
      # Flush settings
      flush = INCREMENTAL_ASYNC
      freq = 50
      
      # Priority boost
      priority_boost = 4
      
      # Network settings
      tcp_listen_queue = 5
      tcp_max_per_addr = 1
      tcp_client_max_idle = 0
      
      # Name settings
      name_format = HOSTNAME
  notify: Restart auditd

- name: Configure audit rules for security events
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/openclaw-security.rules
    owner: root
    group: root
    mode: '0640'
    content: |
      # OpenClaw Security Audit Rules
      # These rules monitor critical security events
      
      # First, delete all existing rules
      -D
      
      # Set buffer size (increase if audit events are being dropped)
      -b 8192
      
      # Set failure mode (2 = panic, 1 = printk, 0 = silent)
      -f 1
      
      # Enable auditing (1 = enabled)
      -e 1
      
      #######################
      # Authentication Events
      #######################
      
      # Monitor login/logout events
      -w /var/log/lastlog -p wa -k logins
      -w /var/log/faillog -p wa -k logins
      -w /var/log/tallylog -p wa -k logins
      
      # Monitor PAM configuration
      -w /etc/pam.d/ -p wa -k pam_config
      
      # Monitor authentication files
      -w /etc/passwd -p wa -k passwd_changes
      -w /etc/shadow -p wa -k shadow_changes
      -w /etc/group -p wa -k group_changes
      -w /etc/gshadow -p wa -k gshadow_changes
      
      # Monitor sudoers
      -w /etc/sudoers -p wa -k sudoers_changes
      -w /etc/sudoers.d/ -p wa -k sudoers_changes
      
      #######################
      # Privilege Escalation
      #######################
      
      # Monitor use of sudo
      -w /usr/bin/sudo -p x -k sudo_usage
      -w /usr/bin/su -p x -k su_usage
      
      # Monitor privilege escalation attempts
      -a always,exit -F arch=b64 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation
      -a always,exit -F arch=b32 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation
      
      #######################
      # Network Configuration
      #######################
      
      # Monitor network configuration changes
      -w /etc/hosts -p wa -k network_config
      -w /etc/hostname -p wa -k network_config
      -w /etc/network/ -p wa -k network_config
      -w /etc/netplan/ -p wa -k network_config
      -w /etc/resolv.conf -p wa -k network_config
      
      # Monitor firewall changes
      -w /etc/ufw/ -p wa -k firewall_changes
      -w /etc/iptables/ -p wa -k firewall_changes
      
      #######################
      # SSH Configuration
      #######################
      
      # Monitor SSH configuration
      -w /etc/ssh/sshd_config -p wa -k sshd_config
      -w /etc/ssh/ssh_config -p wa -k ssh_config
      -w /root/.ssh/ -p wa -k root_ssh
      
      #######################
      # System Services
      #######################
      
      # Monitor systemd service changes
      -w /etc/systemd/ -p wa -k systemd_changes
      -w /lib/systemd/ -p wa -k systemd_changes
      
      # Monitor cron jobs
      -w /etc/crontab -p wa -k cron_changes
      -w /etc/cron.d/ -p wa -k cron_changes
      -w /etc/cron.daily/ -p wa -k cron_changes
      -w /etc/cron.hourly/ -p wa -k cron_changes
      -w /etc/cron.monthly/ -p wa -k cron_changes
      -w /etc/cron.weekly/ -p wa -k cron_changes
      -w /var/spool/cron/ -p wa -k cron_changes
      
      #######################
      # OpenClaw Specific
      #######################
      
      # Monitor OpenClaw configuration
      -w /home/openclaw/.openclaw/ -p wa -k openclaw_config
      
      # Monitor OpenClaw service
      -w /etc/systemd/system/openclaw.service -p wa -k openclaw_service
      
      # Monitor OpenClaw binary execution
      -w /home/openclaw/.local/bin/openclaw -p x -k openclaw_exec
      
      #######################
      # Docker Monitoring
      #######################
      
      # Monitor Docker daemon
      -w /etc/docker/ -p wa -k docker_config
      -w /var/lib/docker/ -p wa -k docker_data
      -w /usr/bin/docker -p x -k docker_usage
      -w /usr/bin/dockerd -p x -k docker_daemon
      
      #######################
      # File Integrity
      #######################
      
      # Monitor important binaries
      -w /sbin/insmod -p x -k kernel_modules
      -w /sbin/rmmod -p x -k kernel_modules
      -w /sbin/modprobe -p x -k kernel_modules
      
      # Monitor kernel module loading
      -a always,exit -F arch=b64 -S init_module -S delete_module -k kernel_modules
      -a always,exit -F arch=b32 -S init_module -S delete_module -k kernel_modules
      
      #######################
      # Time Changes
      #######################
      
      # Monitor time changes
      -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time_change
      -a always,exit -F arch=b32 -S adjtimex -S settimeofday -k time_change
      -a always,exit -F arch=b64 -S clock_settime -k time_change
      -a always,exit -F arch=b32 -S clock_settime -k time_change
      -w /etc/localtime -p wa -k time_change
      
      #######################
      # Make rules immutable
      #######################
      
      # Lock audit configuration (requires reboot to change)
      # Uncomment in production for tamper resistance
      # -e 2
  notify: Restart auditd

- name: Create audit log directory
  ansible.builtin.file:
    path: /var/log/audit
    state: directory
    owner: root
    group: adm
    mode: '0750'

- name: Configure log rotation for audit logs
  ansible.builtin.copy:
    dest: /etc/logrotate.d/audit
    owner: root
    group: root
    mode: '0644'
    content: |
      /var/log/audit/audit.log {
          daily
          rotate 30
          compress
          delaycompress
          missingok
          notifempty
          create 0640 root adm
          postrotate
              /usr/sbin/service auditd rotate > /dev/null 2>&1 || true
          endscript
      }

- name: Enable and start auditd service
  ansible.builtin.systemd:
    name: auditd
    state: started
    enabled: true

- name: Load audit rules
  ansible.builtin.command: augenrules --load
  changed_when: true
  notify: Restart auditd

- name: Verify audit rules are loaded
  ansible.builtin.command: auditctl -l
  register: audit_rules
  changed_when: false

- name: Display loaded audit rules count
  ansible.builtin.debug:
    msg: "Loaded {{ audit_rules.stdout_lines | length }} audit rules"
